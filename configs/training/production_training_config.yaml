# Production training config: 500 epochs on 8 GPUs
# Estimated training time: ~14 days for 500 epochs (~4min/epoch)

# Optimizer parameters
learning_rate: 1.0e-4
batch_size: 2  # Per GPU (minimum for BatchNorm), so 16 total across GPUs
num_epochs: 500  # Full production training
weight_decay: 1.0e-5

# Loss function weights
reconstruction_weight: 1.0
fmri_weight: 1.0
video_weight: 1.0
audio_weight: 1.0
text_weight: 1.0
fmri_loss_type: 'mse'

# Learning rate scheduling
scheduler_type: 'cosine'
warmup_epochs: 10  # Gradual warmup over first 10 epochs
min_lr: 1.0e-6

# Training settings
gradient_clip_val: 1.0
use_mixed_precision: true
num_workers: 2
pin_memory: true

# Checkpointing and logging
checkpoint_dir: 'production_checkpoints'
log_dir: 'production_logs'
save_every: 10  # Save checkpoint every 10 epochs
validate_every: 1  # Validate every epoch

# Early stopping (moderate patience for production)
early_stopping_patience: 50  # Stop if no improvement for 50 epochs
early_stopping_delta: 1.0e-4

# Resume training
resume_from: null

# Data settings
data:
  data_dir: 'data/'
  subjects: [1]  # Single subject for initial production run
  apply_hrf: true
  mode: 'per_subject'
  train_split: 'train'
  val_split: 'val'
  frame_skip: 4  # Memory optimization (Issue #30): Take every 4th frame (75% reduction)
  fps: 25.0  # Video frame rate
  tr: 1.5  # fMRI repetition time

# Model architecture
model:
  video_height: 90
  video_width: 160
  audio_mels: 2048
  text_dim: 3072  # BGE-large (1024) Ã— max_annotations_per_tr (3) in concatenate mode
  n_voxels: 77347  # Actual voxel count from dataset (subject 1 mask)
  bottleneck_dim: 2048  # Layer 7: BOTTLENECK
  video_features: 1024
  audio_features: 256
  text_features: 256
  decoder_hidden_dim: 2048
  decoder_dropout: 0.3
  use_encodec: true  # Use EnCodec (discrete codes) instead of mel spectrograms
  audio_frames_per_tr: 112  # EnCodec frames per TR (vs 65 for mel)
  gradient_checkpointing: true  # Issue #30: Enable to save activation memory (~30-50% reduction)

# Multi-GPU training settings
distributed:
  enabled: true  # Will be set by run_giblet.sh when gpus > 1
  backend: 'nccl'
  world_size: 8
  master_addr: 'localhost'
  master_port: '12355'
